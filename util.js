var apiUrl = 'http://nasbox.writhem.com/power/api.php';function buildTables(apiUrl) {	$('#updating').show();    var request = $.getJSON(apiUrl, function(json) {        $('#outlets').html('')        $('#status').html('')        for (n = 0;n<json.length;++n) {            // console.log(json[n]);            if (typeof json[n].Current != 'undefined')                $('#status').append("Current: " + json[n].Current + ' ' + json[n].Unit + '<br/>\n');            if (typeof json[n].MaxCurrent != 'undefined')			{                $('#status').append("Max Current: " + json[n].MaxCurrent + ' ' + json[n].Unit);                $('#status').append(' [<a href="#" class="cmd" data-cmd="CLEAR">RESET</a>]<br/>\n');			}            if (typeof json[n].Temp != 'undefined')                $('#status').append("Temperature: " + json[n].Temp + ' ' + json[n].Unit + '<br/>\n');            if (typeof json[n].Outlets != 'undefined')            {                var html = "";                html += "    <table cellpadding=\"0\" style=\"width: 100%;text-align:center;\">\n";                html += "    	<thead><th>ID</th><th>Name</th><th>Status</th><th>Control</th></thead>\n";                html += "       <tbody>\n";                for(var i=0;i<json[n].Outlets.length;++i)                 {                    var row = json[n].Outlets[i];                    // console.log(row);                    html += "      <tr id=\"" + row.ID+"\">\n";                    html += buildOutletRow(row);                    html += "      </tr>\n";                }                html += '    <tr><td colspan=3>&nbsp;</td>\n';                html += '    <td>[<a href="#" class="cmd" data-cmd="ON">ALL ON</a>]\n';                html += '    [<a href="#" class="cmd" data-cmd="OFF">ALL OFF</a>]\n';                html += '    [<a href="#" class="cmd" data-cmd="REBOOT">ALL REBOOT</a>]</td></tr>\n';                html += "    </table>\n";                html += "    <br /><hr /><br />\n";                                $('#outlets').append(html);            }        }    })	.fail(function() {		buildTables(apiUrl);	})	.always(function() {        $('.cmd').click(function(t) {			t.preventDefault();            clickCmd(t);        });				$('#updating').hide();		$('.cmd').removeClass('disabled');	});}function buildOutletRow(row) {    var html = "";    html += "    	<td>"+row.ID+"</td>\n";    html += "    	<td>"+row.Name+"</td> \n";    html += "       <td id=\"status-"+row.ID+"\">"+setStatusOnOutletRow(row.Status)+"</td> \n";    html += "    	<td id=\"control-"+row.ID+"\">"+setControlsOnOutletRow(row.ID,row.Status)+"</td> \n";    return html;}function setStatusOnOutletRow(Status) {    var status = 'resolved';    if (Status == "Off")        status = 'outage';    else if (Status == "Reboot")    {        status = 'investigating';        Status = 'Rebooting';    }    return "<img src=\"http://status.writhem.com/"+status+"-16.png\" title=\""+Status+"\" /> <strong>"+Status+"</strong>";}function setControlsOnOutletRow(ID, Status) {    var html = "";    if (Status == 'Off')        html += '[<a href="#" class="cmd" data-cmd="ON '+ID+'" data-row="'+ID+'">ON</a>]';    else     {        html += '[<a href="#" class="cmd" data-cmd="OFF '+ID+'" data-row="'+ID+'">OFF</a>]';        html += '[<a href="#" class="cmd" data-cmd="REBOOT '+ID+'" data-row="'+ID+'">REBOOT</a>]';    }    return html;}function clickCmd(t) {	if($('#updating').is(":hidden")) {		var target = t.currentTarget.dataset.cmd;		var cmd = toTitleCase((target.split(" ")[0]));		var ID = 0;		if (typeof target.split(" ")[1] != 'undefined')			ID = target.split(" ")[1];				if (ID > 0) {			$('#status-'+ID).html(setStatusOnOutletRow(cmd));			$('#control-'+ID).html(setControlsOnOutletRow(ID, cmd));		}		else if (cmd == "On" || cmd == "Off" || cmd == "Reboot")		{			for (var n=1;n<=8;++n) 			{				$('#status-'+n).html(setStatusOnOutletRow(cmd));				$('#control-'+n).html(setControlsOnOutletRow(n, cmd));			}		}				buildTables(apiUrl + '?cmd='+target);				$('.cmd').click(function(t) {			t.preventDefault();			clickCmd(t.currentTarget.dataset.cmd);		});		$('.cmd').addClass('disabled');	}}jQuery(function($){    buildTables(apiUrl);});function toTitleCase(str){    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()});}