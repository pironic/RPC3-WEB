<?phprequire_once('config.php'); $crowd_offline = false;$username = NULL; try {	// http://pear.php.net/package/Services_Atlassian_Crowd	require_once('Services/Atlassian/Crowd.php');		$crowd = new Services_Atlassian_Crowd(array(		'app_name' => $crowd_app_name,		'app_credential' => $crowd_app_password,		'service_url' => $crowd_url,	));}catch (Exception $e) {	// looks like the crowd auth is offline, need a fallback!	$crowd_offline = true;		if (!isset($_SERVER['PHP_AUTH_USER'])) {		header('WWW-Authenticate: Basic realm="RPC3-20 Failover Login"');		header('HTTP/1.0 401 Unauthorized');		// echo 'Text to send if user hits Cancel button';		// exit;	} else {		if ($_SERVER['PHP_AUTH_USER'] == $failover_username && $_SERVER['PHP_AUTH_PW'] == $failover_password)		{			$username = $_SERVER['PHP_AUTH_USER'];			$principal->name = 'Override Account';		}		else		{			header('WWW-Authenticate: Basic realm="RPC3-20 Failover Login"');			header('HTTP/1.0 401 Unauthorized');		}	}}  if (!$crowd_offline) { // only do the crowd stuff if the app is online.	$crowd->authenticateApplication();	$is_authenticated = FALSE;	if (!empty($_COOKIE['crowd_token_key']))	{		try {			// If the user already had a crowd token, we need to verify that it's still valid			$is_authenticated = $crowd->isValidPrincipalToken(				$_COOKIE['crowd_token_key'],				$_SERVER['HTTP_USER_AGENT'],				$_SERVER['REMOTE_ADDR']			);		}		catch (Services_Atlassian_Crowd_Exception $e) 		{			// reprompt for login. User doesn't have access to this app.			header('WWW-Authenticate: Basic realm="RPC3-20 Power Manager Login"');			header('HTTP/1.0 401 Unauthorized');		}	}	if (!$is_authenticated)	{		if (!isset($_SERVER['PHP_AUTH_USER'])) {			header('WWW-Authenticate: Basic realm="RPC3-20 Power Manager Login"');			header('HTTP/1.0 401 Unauthorized');			$username == "";		}	 		try		{			$_COOKIE['crowd_token_key'] = $crowd->authenticatePrincipal(				$_SERVER['PHP_AUTH_USER'],				$_SERVER['PHP_AUTH_PW'],				$_SERVER['HTTP_USER_AGENT'],				$_SERVER['REMOTE_ADDR']			);	 			setcookie('crowd_token_key', $_COOKIE['crowd_token_key'], time() + 3600);	 			$is_authenticated = TRUE;		}		catch (Services_Atlassian_Crowd_Exception $e)		{			// I have no idea why, but instead of throwing an			// invalid username or password exception, we get			// an exception with the username provided if either is wrong.			if ($e->getMessage() == $_SERVER['PHP_AUTH_USER'])			{				// todo: prompt for login again			}			//throw $e;		}	}	 	if ($is_authenticated)	{		$principal = $crowd->findPrincipalByToken($_COOKIE['crowd_token_key']);		// Even though the user may have supplied a username, it's not case sensitive		// and this will make sure the username is always consistent whether they signed		// in using another application or they used http authentication.		$username = $principal->name;	}	if (empty($username))	{		header('HTTP/1.0 401 Unauthorized');		//exit;	}}?><!DOCTYPE html><html lang="en"><head>	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />	<title>WritheM Power Center</title>    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>    <script type="text/javascript" src="http://status.writhem.com/thickbox.js"></script>    <?php if (!empty($username)) echo '<script type="text/javascript" src="util.js"></script>'; ?>    	<link href="http://status.writhem.com/status.css" rel="stylesheet" type="text/css" />	<link rel="stylesheet" href="http://status.writhem.com/thickbox.css" type="text/css" media="screen" />	<link rel="shortcut icon" href="http://status.writhem.com/favicon.ico" type="image/x-icon" /></head><body>	<div id="header">		<a href="http://status.writhem.com/" class="logo">		<img src="https://www.google.com/a/writhem.com/images/logo.gif?alpha=1&service=writhem_status" alt="WritheM Logo" width="143" height="59" border="0">		</a>		<h1>Power Control</h1>		<?php if (!empty($username))			echo "</br></br><h5>Welcome ".$principal->name.".</h5>"; ?>				</div><table style="align:center; width:99%">	<tbody>	<?php	if (!empty($username))	{	?>	<tr>		<td id="leftCol" style="width:500px;"> 			<h3>RPC-3 Outlets</h3>			<div id="outlets">loading...</div>		</td>		<td id="rightCol" style="width:200px;"> 			<h3>RPC-3 Status</h3>			<div id="status">loading...</div>						<div id="updating" style="display:none;"></br><h4>executing command...</h4></div>		</td>	</tr>	<? } else { ?>	<tr>		<td id="leftCol" style="width:500px;"> 			<h3>Denied</h3>			<div id="outlets">Sorry it doesn't look like you have access to this application. Please <a href="javascript:location.reload();">refresh</a> the site to try and login again.</div>		</td>	</tr>	<? } ?>    </tbody></table></body></html>